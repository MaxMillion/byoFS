<!DOCTYPE html>
<html style="height:100%">
    <head>
        <title>Bring Your Own Chat - Proof of Concept</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script src="../../byoFS.js"></script>
        <script src="rsa.min.js"></script>
        <style>
            /*http://meyerweb.com/eric/tools/css/reset/ v2.0 | 20110126 License: none (public domain)*/
            html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small,
            strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas,
            details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {margin:0; padding:0; border:0; font-size:100%; font:inherit; vertical-align:baseline;}
            /* HTML5 display-role reset for older browsers */
            article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {display:block;} body {line-height: 1;} ol, ul {list-style: none;}
            blockquote, q {quotes: none;} blockquote:before, blockquote:after, q:before, q:after {content:''; content:none;} table {border-collapse:collapse; border-spacing:0;}
        </style>
        <style>
            /*App CSS goes here*/
            #widget{float:right;}
            body{font-family:sans-serif;background-color:#f3f3f3;color:#333333;height:100%;}
            #header{z-index:2;display:block;position:absolute;left:0px;top:0px;width:calc(100% - 20px);padding:10px;}
            #header h1{height:20px;overflow:hidden;font-size:18px;font-weight:bold;}
            #state{height:16px;overflow:hidden;font-size:14px;font-style:italic;}
            #settings-row{height:40px;overflow:hidden;}
            #setup{display:inline-block;margin-top:15px;}
            #setup li{display:inline-block;margin-right:5px;}
            #setup a{padding:5px;font-size:14px;border:1px solid #333333;text-decoration:none;background-color:#333333;color:#f3f3f3;}
            #saved{display:inline-block;}
            #saved select{background:#dddddd;padding:5px;font-size:14px;line-height:1;border:1px solid #333333;border-radius:0;}
            #content{width:calc(100% - 40px);margin:10px;padding:10px;border:1px solid #333333;background-color:#f3f3f3;position:fixed;top:85px;bottom:0px;}
            #close{display:block;position:absolute;right:3px;top:3px;text-decoration:none;color:#999999;font-size:15px;}
            #close:hover{color:#333333;}
            #chat{display:block;position:absolute;bottom:30px;top:10px;width:calc(100% - 50px);background-color:#dddddd;padding:10px;margin-bottom:10px;overflow-y:auto;}
            .line{background-color:#f3f3f3;margin:5px 10px;display:inline-block;padding:10px;}
            .right{text-align:right;}
            .right .line{border-radius:10px 10px 0 10px;}
            .left{text-align:left;}
            .left .line{border-radius:10px 10px 10px 0;}
            .author{font-family:monospace;font-size:14px;}
            .message{font-size:16px;font-family:serif;padding-top:10px;}
            #content form{display:block;position:absolute;bottom:5px;width:calc(100% - 20px);}
            #in{padding:5px;border:1px solid #333333;border-radius:0;width:calc(100% - 114px);min-width:50%;}
            #go{padding:5px;border:0;border-radius:0;background-color:#333333;color:#f3f3f3;width:90px;}
        </style>
    </head>
    <body>
        <!--HTML Goes Here-->
        <div id="header">
            <div id="widget"></div>
            <h1>Bring Your Own Chat (an example <a href="https://github.com/diafygi/byoFS" target="_blank">byoFS</a> app)</h1>
            <div id="state"></div>
            <div id="settings-row">
                <ul id="setup">
                    <li><a id="gen_code" href="#">Create a new chat code</a></li>
                    <li><a id="get_code" href="#">Received a chat code?</a></li>
                </ul>
                <div id="saved">
                    <select id="saved-list">
                        <option value="blank_state" selected>Previously Saved Chats</option>
                        <option value="load_123456">Chat 123456</li>
                        <option value="load_123457">Chat 123456</li>
                        <option value="load_123458">Chat 123456</li>
                    </select>
                </div>
            </div>
        </div>
        <div id="content">
            <a id="close" href="#" title="close">X</a>
            <div id="chat">
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">Howdy :)</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">This is my message!</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">I received your message</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">10-4 good buddy</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">Howdy :)</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">This is my message!</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">I received your message</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">10-4 good buddy</div>
                    </div>
                </div>
            </div>
            <form>
                <input id="in" placeholder="type message here"/>
                <input id="go" type="submit" value="Submit"/>
            </form>
        </div>

        <!--App code goes here-->
        <script>
            //global settings
            var bits = 512;
            var fs;
            var index = {};

            //create new password to be shared
            function new_pass(len){
                var pass_array = new Uint32Array(64);
                window.crypto.getRandomValues(pass_array);
                var pass = "";
                for (var i = 0; i < pass_array.length; i++) {
                    pass += pass_array[i].toString(16);
                }
                if(len === undefined)
                    return pass.substring(0, bits / 16 - 6);
                else
                    return pass.substring(0, len);
            }

            //create new public private key pair
            function new_rsa(){
                var rsa1 = new RSAKey();
                rsa1.generate(bits, "10001");
                return {
                    "pub": rsa1.n.toString(16) + "," + rsa1.e.toString(16),
                    "priv": rsa1.n.toString(16) + "," + rsa1.e.toString(16) + "," + rsa1.d.toString(16) + "," + rsa1.p.toString(16) + "," + rsa1.q.toString(16) + "," + rsa1.dmp1.toString(16) + "," + rsa1.dmq1.toString(16) + "," + rsa1.coeff.toString(16),
                }
            }

            //encrypt string with public key
            function enc_rsa(str, pubstr){
                var rsa2 = new RSAKey();
                var pub = pubstr.split(",");
                rsa2.setPublic(pub[0], pub[1]);
                return rsa2.encrypt(str);
            }

            //decyrpt string with private key
            function dec_rsa(str, privstr){
                var rsa3 = new RSAKey();
                var priv = privstr.split(",");
                rsa3.setPrivateEx(priv[0], priv[1], priv[2], priv[3], priv[4], priv[5], priv[6], priv[7]);
                return rsa3.decrypt(enc);
            }

            //show a popup of the code
            function show_code(e){
                e.preventDefault();
                console.log(e.target.title);
                prompt("Copy the below code and send it to the person you want to chat with.", e.target.title);
            }

            //generate a new public key
            function gen_code(e){
                e.preventDefault();
                document.getElementById("state").innerHTML = "Generating new chat code...";
                //gen new id
                var id = new_pass(8);
                while(index[id] !== undefined)
                    id = new_pass(8);

                //generate new key pair
                var kp = new_rsa();

                //write public key to file
                document.getElementById("state").innerHTML = "Saving new chat code...";
                fs.write({"name": "pub-"+id, "pub": true}, kp['pub'], function(pxhr){
                    //update index with new key pair
                    index[id] = {
                        "id": id,
                        "kp": kp,
                        "pub_url": pxhr.responseText,
                    };
                    var b64_code = window.btoa("pub=" + index[id]['pub_url']);
                    fs.write("index", JSON.stringify(index), function(){
                        document.getElementById("state").innerHTML = 'Here is your <a id="new_b64_code" href="#" title="'+b64_code+'">code</a>.';
                        document.getElementById("new_b64_code").addEventListener("click", show_code);
                    });
                }, true);
            }

            //input a remote public key
            function get_code(e){
                e.preventDefault();
                document.getElementById("state").innerHTML = "Waiting for chat code input...";
                //##########################
            }

            function load_data(chat_id){
                //hide chat window if no chat selected
                if(chat_id === undefined){
                    document.getElementById("content").style.display = "none";
                }
                else{
                    document.getElementById("content").style.display = "block";
                    //load chat history and start monitoring other side#########################
                }

                //add previous chats to history dropdown
                var out = '<option value="blank_state" selected>Previously Saved Chats</option>';
                for(var k in index)
                    out += '<option value="' + index[k]['id'] + '">Chat ' + index[k]['id'] + '</li>';
                document.getElementById("saved-list").innerHTML = out;
                //######################change dropdown chat history#############

                //bind click events to gen/get code buttons
                document.getElementById("gen_code").addEventListener("click", gen_code);
                document.getElementById("get_code").addEventListener("click", get_code);

                //show settings-row
                document.getElementById("settings-row").style.display = "block";
                document.getElementById("state").innerHTML = "Ready to rock and roll!";
            }

            function setup_app(){
                document.getElementById("state").innerHTML = "Setting up...";
                //see if the index exists
                fs.read("index", function(pxhr){
                    //no index, assume registration and create index file
                    if(pxhr.statusText === "404 Not Found"){
                        document.getElementById("state").innerHTML = "No index found, creating one...";
                        fs.write("index", JSON.stringify({}), function(){
                            setup_app();
                        });
                    }
                    //bad password
                    else if(pxhr.statusText === "401 Unauthorized"){
                        alert("Couldn't decrypt with that password :(")
                        app_init();
                    }
                    //some other error occurred
                    else if(pxhr.statusText !== "200 OK"){
                        alert("Something went wrong :(")
                        app_init();
                    }
                    //index found
                    else{
                        //load chat history
                        document.getElementById("state").innerHTML = "Parsing index...";
                        index = JSON.parse(pxhr.responseText);
                        load_data();
                    }
                });
            }

            function app_init(){
                document.getElementById("state").innerHTML = "Click the Dropbox icon to connect! --->";
                document.getElementById("settings-row").style.display = "none";
                document.getElementById("content").style.display = "none";
                byoFS("byoChat", "#widget", function(connected_fs){
                    fs = connected_fs;
                    setup_app();
                });
            }
            app_init();
        </script>
    </body>
</html>
