<!DOCTYPE html>
<html style="height:100%">
    <head>
        <title>Bring Your Own Chat - Proof of Concept</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script src="../../byoFS.js"></script>
        <script src="rsa.min.js"></script>
        <style>
            /*http://meyerweb.com/eric/tools/css/reset/ v2.0 | 20110126 License: none (public domain)*/
            html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small,
            strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas,
            details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {margin:0; padding:0; border:0; font-size:100%; font:inherit; vertical-align:baseline;}
            /* HTML5 display-role reset for older browsers */
            article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {display:block;} body {line-height: 1;} ol, ul {list-style: none;}
            blockquote, q {quotes: none;} blockquote:before, blockquote:after, q:before, q:after {content:''; content:none;} table {border-collapse:collapse; border-spacing:0;}
        </style>
        <style>
            /*App CSS goes here*/
            #widget{float:right;}
            body{font-family:sans-serif;background-color:#f3f3f3;color:#333333;height:100%;}
            #header{z-index:2;display:block;position:absolute;left:0px;top:0px;width:calc(100% - 20px);padding:10px;}
            #header h1{height:20px;overflow:hidden;font-size:18px;font-weight:bold;}
            #state{height:16px;overflow:hidden;font-size:14px;font-style:italic;}
            #settings-row{height:40px;overflow:hidden;}
            #setup{display:inline-block;margin-top:15px;}
            #setup li{display:inline-block;margin-right:5px;}
            #setup a{padding:5px;font-size:14px;border:1px solid #333333;text-decoration:none;background-color:#333333;color:#f3f3f3;}
            #saved{display:inline-block;}
            #saved select{background:#dddddd;padding:5px;font-size:14px;line-height:1;border:1px solid #333333;border-radius:0;}
            #content{width:calc(100% - 40px);margin:10px;padding:10px;border:1px solid #333333;background-color:#f3f3f3;position:fixed;top:85px;bottom:0px;}
            #close{display:block;position:absolute;right:3px;top:3px;text-decoration:none;color:#999999;font-size:15px;}
            #close:hover{color:#333333;}
            #chat{display:block;position:absolute;bottom:30px;top:10px;width:calc(100% - 50px);background-color:#dddddd;padding:10px;margin-bottom:10px;overflow-y:auto;}
            .line{background-color:#f3f3f3;margin:5px 10px;display:inline-block;padding:10px;}
            .right{text-align:right;}
            .right .line{border-radius:10px 10px 0 10px;}
            .left{text-align:left;}
            .left .line{border-radius:10px 10px 10px 0;}
            .author{font-family:monospace;font-size:14px;}
            .message{font-size:16px;font-family:serif;padding-top:10px;}
            #content form{display:block;position:absolute;bottom:5px;width:calc(100% - 20px);}
            #in{padding:5px;border:1px solid #333333;border-radius:0;width:calc(100% - 114px);min-width:50%;}
            #go{padding:5px;border:0;border-radius:0;background-color:#333333;color:#f3f3f3;width:90px;}
        </style>
    </head>
    <body>
        <!--HTML Goes Here-->
        <div id="header">
            <div id="widget"></div>
            <h1>Bring Your Own Chat (an example <a href="https://github.com/diafygi/byoFS" target="_blank">byoFS</a> app)</h1>
            <div id="state"></div>
            <div id="settings-row">
                <ul id="setup">
                    <li><a id="gen_code" href="#">Create a new chat code</a></li>
                    <li><a id="get_code" href="#">Received a chat code?</a></li>
                </ul>
                <div id="saved">
                    <select id="saved-list">
                        <option value="blank_state" selected>Previously Saved Chats</option>
                        <option value="load_123456">Chat 123456</li>
                        <option value="load_123457">Chat 123456</li>
                        <option value="load_123458">Chat 123456</li>
                    </select>
                </div>
            </div>
        </div>
        <div id="content">
            <a id="close" href="#" title="close">X</a>
            <div id="chat">
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">Howdy :)</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">This is my message!</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">I received your message</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">10-4 good buddy</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">Howdy :)</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">This is my message!</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">I received your message</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">10-4 good buddy</div>
                    </div>
                </div>
            </div>
            <form>
                <input id="in" placeholder="type message here"/>
                <input id="go" type="submit" value="Submit"/>
            </form>
        </div>

        <!--App code goes here-->
        <script>
            //global settings
            var BITS = 512;
            var fs;
            var index = {};
            var local_cache = {};
            var remote_cache = {};
            /*
            index = {
                "<chat_id>": {
                    "local": {
                        "pub": <local_public_key_string>,
                        "pub_url": <public_url_of_local_public_key>,
                        "priv": <local_private_key_string>,
                        "key": <shared_key_string>,
                        "key_url": <public_url_of_shared_key_encrypted_with_remote_public_key>,
                        "log_url": <public_url_of_local_side_of_chat>,
                    },
                    "remote": {
                        "pub": <remote_public_key_string>,
                        "pub_url": <public_url_of_remote_public_key>,
                        "key_url": <public_url_of_shared_key_encrypted_with_local_public_key>,
                        "log_url": <public_url_of_remote_chat_log_encrypted_with_shared_key>,
                    },
                }
            }
            */

            //create new password to be shared
            function new_pass(len){
                var pass_array = new Uint32Array(64);
                window.crypto.getRandomValues(pass_array);
                var pass = "";
                for (var i = 0; i < pass_array.length; i++) {
                    pass += pass_array[i].toString(16);
                }
                return pass.substring(0, len);
            }

            //create new public private key pair
            function new_rsa(){
                var rsa1 = new RSAKey();
                rsa1.generate(BITS, "10001");
                return {
                    "pub": rsa1.n.toString(16) + "," + rsa1.e.toString(16),
                    "priv": rsa1.n.toString(16) + "," + rsa1.e.toString(16) + "," + rsa1.d.toString(16) + "," + rsa1.p.toString(16) + "," + rsa1.q.toString(16) + "," + rsa1.dmp1.toString(16) + "," + rsa1.dmq1.toString(16) + "," + rsa1.coeff.toString(16),
                }
            }

            //encrypt string with public key
            function enc_rsa(str, pubstr){
                var rsa2 = new RSAKey();
                var pub = pubstr.split(",");
                rsa2.setPublic(pub[0], pub[1]);
                return rsa2.encrypt(str);
            }

            //decyrpt string with private key
            function dec_rsa(str, privstr){
                var rsa3 = new RSAKey();
                var priv = privstr.split(",");
                rsa3.setPrivateEx(priv[0], priv[1], priv[2], priv[3], priv[4], priv[5], priv[6], priv[7]);
                return rsa3.decrypt(str);
            }

            //show a popup of the code
            function show_code(e){
                e.preventDefault();
                prompt("Copy the below code and send it to the person you want to chat with.", e.target.title);
            }

            //search current index for public key reference
            function search_using_ref(ref){
                for(var k in index){
                    if(index[k]['local'] !== undefined && index[k]['local']['pub_url'] === ref)
                        return k;
                }
                return null;
            }

            //generate a new public key
            function gen_code(e, callback){
                if(e !== null)
                    e.preventDefault();
                document.getElementById("state").innerHTML = "Generating new chat code...";
                //gen new id
                var id = new_pass(8);
                while(index[id] !== undefined)
                    id = new_pass(8);

                //generate new key pair
                var kp = new_rsa();
                index[id] = {"local": kp};

                //write public key to file
                document.getElementById("state").innerHTML = "Saving new key pair...";
                fs.write({"name": "pub-"+id, "pub": true}, kp['pub'], function(pxhr){
                    //update index with new key pair and public url
                    index[id]['local']['pub_url'] = pxhr.responseText;

                    //generate placeholder key file
                    document.getElementById("state").innerHTML = "Saving new shared key...";
                    fs.write({"name": "key-"+id, "pub": true}, "", function(pxhr){
                        index[id]['local']['key_url'] = pxhr.responseText;

                        //generate placeholder log file
                        document.getElementById("state").innerHTML = "Saving new chat...";
                        fs.write({"name": "log-"+id, "pub": true}, "", function(pxhr){
                            index[id]['local']['log_url'] = pxhr.responseText;

                            //generate placeholder log file
                            document.getElementById("state").innerHTML = "Chat created! Updating index...";
                            fs.write("index", JSON.stringify(index), function(){
                                //if there was a callback, call that
                                if(callback !== undefined){
                                    callback(id);
                                }
                                //no callback defaults to showing code
                                else{
                                    var b64_code = window.btoa(JSON.stringify({
                                        "pub": index[id]['local']['pub_url'],
                                        "key": index[id]['local']['key_url'],
                                        "log": index[id]['local']['log_url'],
                                    }));
                                    document.getElementById("state").innerHTML = 'Here is your <a id="new_b64_code" href="#" title="'+b64_code+'">chat code</a>.';
                                    document.getElementById("new_b64_code").addEventListener("click", show_code);
                                }
                            });
                        });

                    });
                });
            }

            //input a remote public key
            function get_code(e){
                e.preventDefault();
                //get user to input received chat code and convert to chat config
                document.getElementById("state").innerHTML = "Waiting for chat code input...";
                var conf = prompt("Paste the code you received.");
                if(conf === null || conf === "")
                    return;
                conf = JSON.parse(window.atob(conf));

                //retrieve public key
                document.getElementById("state").innerHTML = "Retrieving their public key...";
                var xhr = new XMLHttpRequest();
                xhr.open("GET", conf['pub']);
                xhr.onreadystatechange = function(){
                    if(xhr.readyState === 4){
                        if(xhr.status !== 200){
                            document.getElementById("state").innerHTML = "Error retrieving their public key :(";
                        }
                        else{
                            //see if any existing chats that are based on one of the local public key urls
                            var remote_pub = xhr.responseText;
                            var cur_id = search_using_ref(conf['ref']);

                            //no existing chat, so make a new one
                            if(cur_id === null){
                                document.getElementById("state").innerHTML = "No existing chat matches, creating new...";
                                //create placeholder files
                                gen_code(null, function(new_id){

                                    //update placeholder files using received public key
                                    document.getElementById("state").innerHTML = "Creating new shared key...";
                                    index[new_id]['local']['key'] = new_pass(parseInt(BITS / 16 - 6));
                                    var enc_key = enc_rsa(index[new_id]['local']['key'], remote_pub);
                                    fs.write({"name": "key-"+new_id, "pub": true}, enc_key, function(pxhr){
                                        index[new_id]['local']['key'] = pxhr.responseText;

                                        //update chat log placeholder with shared key
                                        document.getElementById("state").innerHTML = "Creating new chat...";
                                        local_cache[new_id] = [];
                                        var new_log = sjcl.encrypt(index[new_id]['local']['key'], JSON.stringify(local_cache[new_id]));
                                        fs.write({"name": "log-"+new_id, "pub": true}, JSON.stringify(new_log), function(pxhr){
                                            index[new_id]['local']['log_url'] = pxhr.responseText;

                                            //update the index with all the new configuration
                                            document.getElementById("state").innerHTML = "Updating index with new chat...";
                                            index[new_id]['remote'] = {
                                                "pub": remote_pub,
                                                "pub_url": conf['pub'],
                                                "key_url": conf['key'],
                                                "log_url": conf['log'],
                                            };
                                            fs.write("index", JSON.stringify(index), function(){
                                                //show message with response code
                                                var b64_code = window.btoa(JSON.stringify({
                                                    "ref": index[new_id]['remote']['pub_url'],
                                                    "pub": index[new_id]['local']['pub_url'],
                                                    "key": index[new_id]['local']['key_url'],
                                                    "log": index[new_id]['local']['log_url'],
                                                }));
                                                document.getElementById("state").innerHTML = 'Chat created! Reply with this new <a id="new_b64_code" href="#" title="'+b64_code+'">chat code</a>.';
                                                document.getElementById("new_b64_code").addEventListener("click", show_code);
                                                console.log("Good to go3!");//########################
                                            });
                                        });
                                    });
                                });
                            }
                            //chat exists!
                            else{
                                //ask for override if remote public key isnt the same as index value
                                if(index[cur_id]['remote'] !== undefined && index[cur_id]['remote']['pub'] !== remote_pub){
                                    if(!confirm("The person you are chatting with seems to have changed their key! Press OK to override and use their new key.")){
                                        document.getElementById("state").innerHTML = "Couldn't load chat :(";
                                        return;
                                    }
                                }
                                //update local shared key and chat log to match remote's
                                index[cur_id]['remote'] = {
                                    "pub": remote_pub,
                                    "pub_url": conf['pub'],
                                    "key_url": conf['key'],
                                    "log_url": conf['log'],
                                }
                                //get shared key from remote
                                document.getElementById("state").innerHTML = "Verifying chat key...";
                                var xhr_key = new XMLHttpRequest();
                                xhr_key.open("GET", conf['key']);
                                xhr_key.onreadystatechange = function(){
                                    if(xhr_key.readyState === 4){
                                        if(xhr_key.status !== 200){
                                            document.getElementById("state").innerHTML = "Error verifying their chat key :(";
                                        }
                                        else{
                                            //decrypt shared key using local private key
                                            var remote_shared = dec_rsa(xhr_key.responseText, index[cur_id]['local']['priv']);

                                            //ask for override if remote shared doesn't match
                                            if(index[cur_id]['local']['key'] !== undefined && index[cur_id]['local']['key'] !== remote_shared){
                                                if(!confirm("The shared chat encryption doesn't match! Press OK to override and re-encrypt using the received key.")){
                                                    document.getElementById("state").innerHTML = "Couldn't load chat :(";
                                                    return;
                                                }
                                            }

                                            //update shared key using remote public
                                            document.getElementById("state").innerHTML = "Updating chat key...";
                                            var enc_key = enc_rsa(remote_shared, index[cur_id]['remote']['pub']);
                                            fs.write({"name": "key-"+cur_id, "pub": true}, enc_key, function(pxhr){

                                                //re-encrypt using shared key if not the same (already asked for confirmation above)
                                                if(index[cur_id]['local']['key'] !== undefined && index[cur_id]['local']['key'] !== remote_shared){
                                                    document.getElementById("state").innerHTML = "Re-encrypting using new chat key...";
                                                    var xhr_re = new XMLHttpRequest();
                                                    xhr_re.open("GET", index[cur_id]['local']['log_url']);
                                                    xhr_re.onreadystatechange = function(){
                                                        if(xhr_re.readyState === 4){
                                                            if(xhr_re.status !== 200){
                                                                //re-encrypt
                                                                local_cache[cur_id] = sjcl.decrypt(index[cur_id]['local']['key'], JSON.parse(xhr_re.responseText));
                                                                var enc_log = sjcl.encrypt(remote_shared, JSON.stringify(local_cache[cur_id]));
                                                                //save re-encrypted file
                                                                fs.write({"name": "log-"+cur_id, "pub": true}, enc_log, function(pxhr){

                                                                    //update index
                                                                    document.getElementById("state").innerHTML = "Updating index with re-encryption...";
                                                                    index[cur_id]['local']['key'] = remote_shared;
                                                                    fs.write("index", JSON.stringify(index), function(){
                                                                        document.getElementById("state").innerHTML = "Re-encrypted chat ready!";
                                                                        console.log("Good to go1!");//########################
                                                                    });
                                                                });
                                                            }
                                                        }
                                                    };
                                                    xhr_re.send();
                                                }
                                                //no previously existing shared key, so set the received one and initialize chat log
                                                else{
                                                    //encrypt new empty chat log
                                                    document.getElementById("state").innerHTML = "Creating new chat...";
                                                    var enc_log = sjcl.encrypt(remote_shared, JSON.stringify([]));
                                                    //save initialized chat log
                                                    fs.write({"name": "log-"+cur_id, "pub": true}, enc_log, function(pxhr){

                                                        //update index
                                                        document.getElementById("state").innerHTML = "Updating index with new chat...";
                                                        index[cur_id]['local']['key'] = remote_shared;
                                                        fs.write("index", JSON.stringify(index), function(){
                                                            document.getElementById("state").innerHTML = "New chat ready!";
                                                            console.log("Good to go2!");//########################
                                                        });
                                                    });
                                                }
                                            });

                                        }
                                    }
                                };
                                xhr_key.send();
                            }
                        }
                    }
                };
                xhr.send();
            }

            function load_data(chat_id){
                //hide chat window if no chat selected
                if(chat_id === undefined){
                    document.getElementById("content").style.display = "none";
                }
                else{
                    document.getElementById("content").style.display = "block";
                    //load chat history and start monitoring other side#########################
                }

                //add previous chats to history dropdown
                var out = '<option value="blank_state" selected>Previously Saved Chats</option>';
                for(var k in index)
                    out += '<option value="' + index[k]['id'] + '">Chat ' + index[k]['id'] + '</li>';
                document.getElementById("saved-list").innerHTML = out;
                //######################change dropdown chat history#############

                //bind click events to gen/get code buttons
                document.getElementById("gen_code").addEventListener("click", gen_code);
                document.getElementById("get_code").addEventListener("click", get_code);

                //show settings-row
                document.getElementById("settings-row").style.display = "block";
                document.getElementById("state").innerHTML = "Ready to rock and roll!";
            }

            function setup_app(){
                document.getElementById("state").innerHTML = "Setting up...";
                //see if the index exists
                fs.read("index", function(pxhr){
                    //no index, assume registration and create index file
                    if(pxhr.statusText === "404 Not Found"){
                        document.getElementById("state").innerHTML = "No index found, creating one...";
                        fs.write("index", JSON.stringify({}), function(){
                            setup_app();
                        });
                    }
                    //bad password
                    else if(pxhr.statusText === "401 Unauthorized"){
                        alert("Couldn't decrypt with that password :(")
                        app_init();
                    }
                    //some other error occurred
                    else if(pxhr.statusText !== "200 OK"){
                        alert("Something went wrong :(")
                        app_init();
                    }
                    //index found
                    else{
                        //load chat history
                        document.getElementById("state").innerHTML = "Parsing index...";
                        index = JSON.parse(pxhr.responseText);
                        load_data();
                    }
                });
            }

            function app_init(){
                document.getElementById("state").innerHTML = "Click the Dropbox icon to connect! --->";
                document.getElementById("settings-row").style.display = "none";
                document.getElementById("content").style.display = "none";
                byoFS("byoChat", "#widget", function(connected_fs){
                    fs = connected_fs;
                    setup_app();
                });
            }
            app_init();
        </script>
    </body>
</html>
